language: python

python:
  - "3.6"

env:
  global:
    - DOWNLOADS=$HOME/downloads
    - LIB=$HOME/lib
    - DERIVATIVES=tests/data/derivatives
    - INSTALL=$HOME/bin
    - SOURCE_PATH=$TRAVIS_BUILD_DIR/docs/source
    - API_PATH=$SOURCE_PATH/api
    - BUILD_PATH=$TRAVIS_BUILD_DIR/docs/build
    - HTML_PATH=$TRAVIS_BUILD_DIR/docs/build/html

cache: 
 - directories:
   - $HOME/.cache/pip

before_install:
  # install neurodebian (without spyware)
  - sudo apt-get update -qq
  - source /etc/lsb-release
  - wget -O- http://neuro.debian.net/lists/${DISTRIB_CODENAME}.us-nh.full | sudo tee /etc/apt/sources.list.d/neurodebian.sources.list
  - wget -q -O- http://neuro.debian.net/_static/neuro.debian.net.asc | sudo apt-key add -;
  - sudo apt-get update -qq

  # necessary for nipype plots
  - sudo apt-get install -y -qq graphviz

install:
  # install requirements
  - pip install numpy -U
  - pip install scipy pyqt5
  - pip install cython
  - pip install nibabel vispy wonambi bidso plotly popeye sanajeh scikit-image
  - pip install nipype
  - pip install -e git+https://github.com/gpiantoni/exportimages.git#egg=exportimages  # this should be in pypi
  - pip install pytest pytest-qt pytest-cov codecov
  - pip install -e .

before_script:
  - export DISPLAY=:99.0;
  - /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -screen 0 1400x900x24 -ac +extension GLX +render;

script:
  - python -c "import vispy; print(vispy.sys_info())"
  - py.test --cov=boavus tests
  - find tests/data -type f -printf "\n%TY/%Tm/%Td %TH:%TM:%TS\t%s\n" -exec md5sum \{\} \;

after_success:
  - codecov
  - pip install sphinx sphinx_rtd_theme
  - sphinx-apidoc -fMeT -o $API_PATH boavus
  - sphinx-build -T -b html -d $BUILD_PATH/doctrees $SOURCE_PATH $HTML_PATH

notifications:
  email: false

deploy:
 - provider: pages
   skip_cleanup: true
   target_branch : gh-pages
   local_dir : docs/build/html
   repo : gpiantoni/boavus
   github_token : $GITHUB_TOKEN
